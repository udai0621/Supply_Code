<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>機械学習モデルをAPI化するチュートリアル</title>
    <style>
        @page {
            margin: 2cm;
            size: A4;
        }

```
    * {
        box-sizing: border-box;
    }
    
    body {
        font-family: 'Segoe UI', 'Hiragino Sans', 'Yu Gothic UI', Meiryo, sans-serif;
        line-height: 1.6;
        color: #333;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: white;
    }
    
    h1 {
        color: #2c3e50;
        border-bottom: 3px solid #3498db;
        padding-bottom: 10px;
        margin-top: 0;
        font-size: 2em;
    }
    
    h2 {
        color: #34495e;
        margin-top: 2em;
        margin-bottom: 1em;
        font-size: 1.5em;
        border-left: 4px solid #3498db;
        padding-left: 15px;
    }
    
    h3 {
        color: #2c3e50;
        margin-top: 1.5em;
        margin-bottom: 0.8em;
        font-size: 1.2em;
    }
    
    h4 {
        color: #34495e;
        margin-top: 1.2em;
        margin-bottom: 0.5em;
        font-size: 1.1em;
    }
    
    p {
        margin-bottom: 1em;
        text-align: justify;
    }
    
    .highlight {
        background: #fff3cd;
        padding: 15px;
        border-left: 4px solid #ffc107;
        margin: 1em 0;
        border-radius: 0 5px 5px 0;
    }
    
    pre {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 5px;
        padding: 15px;
        overflow-x: auto;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.9em;
        line-height: 1.4;
        margin: 1em 0;
        page-break-inside: avoid;
    }
    
    code {
        background: #f1f3f4;
        padding: 2px 6px;
        border-radius: 3px;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.9em;
    }
    
    pre code {
        background: none;
        padding: 0;
    }
    
    .step-box {
        background: #e8f5e8;
        border: 1px solid #4caf50;
        border-radius: 8px;
        padding: 20px;
        margin: 1.5em 0;
        page-break-inside: avoid;
    }
    
    .step-title {
        font-weight: bold;
        color: #2e7d32;
        margin-bottom: 10px;
        font-size: 1.1em;
    }
    
    .warning {
        background: #fff3e0;
        border: 1px solid #ff9800;
        border-radius: 5px;
        padding: 15px;
        margin: 1em 0;
    }
    
    .warning::before {
        content: "⚠️ ";
        font-weight: bold;
    }
    
    .info {
        background: #e3f2fd;
        border: 1px solid #2196f3;
        border-radius: 5px;
        padding: 15px;
        margin: 1em 0;
    }
    
    .info::before {
        content: "💡 ";
    }
    
    .example {
        background: #f3e5f5;
        border: 1px solid #9c27b0;
        border-radius: 5px;
        padding: 15px;
        margin: 1em 0;
    }
    
    .example::before {
        content: "🔧 例: ";
        font-weight: bold;
        color: #7b1fa2;
    }
    
    ul, ol {
        padding-left: 30px;
        margin-bottom: 1em;
    }
    
    li {
        margin-bottom: 0.5em;
    }
    
    .toc {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin: 2em 0;
        page-break-inside: avoid;
    }
    
    .toc h2 {
        margin-top: 0;
        color: #495057;
        border: none;
        padding: 0;
    }
    
    .toc ul {
        list-style-type: none;
        padding-left: 0;
    }
    
    .toc ul ul {
        padding-left: 20px;
        margin-top: 0.5em;
    }
    
    .toc a {
        color: #007bff;
        text-decoration: none;
    }
    
    .toc a:hover {
        text-decoration: underline;
    }
    
    .download-info {
        position: fixed;
        top: 10px;
        right: 10px;
        background: #28a745;
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        font-size: 0.9em;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        z-index: 1000;
    }
    
    @media print {
        .download-info {
            display: none;
        }
        
        body {
            max-width: none;
            padding: 0;
        }
        
        h1, h2, h3, h4 {
            page-break-after: avoid;
        }
        
        pre, .step-box, .warning, .info, .example {
            page-break-inside: avoid;
        }
    }
    
    .footer {
        margin-top: 3em;
        padding-top: 2em;
        border-top: 1px solid #dee2e6;
        text-align: center;
        color: #6c757d;
        font-size: 0.9em;
    }
</style>
```

</head>
<body>
    <div class="download-info">
        Ctrl+P (Windows) または Cmd+P (Mac) でPDF保存できます
    </div>

```
<h1>機械学習モデルをAPI化するチュートリアル</h1>

<div class="toc">
    <h2>目次</h2>
    <ul>
        <li><a href="#introduction">1. はじめに</a></li>
        <li><a href="#prerequisites">2. 前提条件</a></li>
        <li><a href="#installation">3. 必要なライブラリのインストール</a></li>
        <li><a href="#step1">4. ステップ1: 機械学習モデルの作成</a></li>
        <li><a href="#step2">5. ステップ2: Flask APIの作成</a></li>
        <li><a href="#step3">6. ステップ3: APIの起動とテスト</a></li>
        <li><a href="#step4">7. ステップ4: エラーハンドリングの改善</a></li>
        <li><a href="#step5">8. ステップ5: 本番環境への対応</a></li>
        <li><a href="#step6">9. ステップ6: APIドキュメントの作成</a></li>
        <li><a href="#summary">10. まとめ</a></li>
        <li><a href="#next-steps">11. 次のステップ</a></li>
    </ul>
</div>

<section id="introduction">
    <h2>はじめに</h2>
    
    <div class="highlight">
        <p>機械学習モデルを作ったら、次はそれを実際に使える形にする必要があります。これは<strong>レストランで料理を作った後、お客さんに提供するためのサービス体制を整える</strong>のと似ています。</p>
    </div>
    
    <p>どんなに美味しい料理（優秀なモデル）を作っても、お客さん（ユーザー）が簡単に注文できて、すぐに提供される仕組みがないと意味がありません。</p>
    
    <p>このチュートリアルでは、Python の Flask を使って、機械学習モデルを Web API として公開する方法を学びます。</p>
</section>

<section id="prerequisites">
    <h2>前提条件</h2>
    <ul>
        <li>Python の基本知識</li>
        <li>機械学習の基礎知識（scikit-learn を使ったことがある）</li>
        <li>コマンドライン操作の基本</li>
    </ul>
</section>

<section id="installation">
    <h2>必要なライブラリのインストール</h2>
    
    <pre><code>pip install flask scikit-learn pandas numpy joblib requests</code></pre>
</section>

<section id="step1">
    <h2>ステップ1: 簡単な機械学習モデルの作成</h2>
    
    <div class="info">
        まず、アイリスの花の分類を行う簡単なモデルを作成します。これは<strong>花の専門家が花びらと萼片の長さ・幅を見て品種を判定する</strong>のをコンピューターに教える作業です。
    </div>

    <pre><code># model_training.py
```

from sklearn import datasets
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split
import joblib

# データの読み込み

iris = datasets.load_iris()
X, y = iris.data, iris.target

# 訓練・テストデータの分割

X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# モデルの訓練

model = RandomForestClassifier(n_estimators=100, random_state=42)
model.fit(X_train, y_train)

# モデルの保存

joblib.dump(model, ‘iris_model.pkl’)

# 品種名のマッピングも保存

species_mapping = {0: ‘setosa’, 1: ‘versicolor’, 2: ‘virginica’}
joblib.dump(species_mapping, ‘species_mapping.pkl’)

print(“モデルの訓練完了！”)
print(f”テストデータでの精度: {model.score(X_test, y_test):.2f}”)</code></pre>
</section>

```
<section id="step2">
    <h2>ステップ2: Flask を使った基本的な API の作成</h2>
    
    <div class="info">
        次に、保存したモデルを読み込んで、Web API として公開します。これは<strong>レストランの注文システム</strong>のようなものです。
    </div>

    <pre><code># app.py
```

from flask import Flask, request, jsonify
import joblib
import numpy as np

# Flask アプリケーションの初期化

app = Flask(**name**)

# モデルと品種マッピングの読み込み

model = joblib.load(‘iris_model.pkl’)
species_mapping = joblib.load(‘species_mapping.pkl’)

@app.route(’/’)
def home():
“”“APIの説明ページ”””
return “””
<h1>アイリス分類API</h1>
<p>花びらと萼片の測定値から、アイリスの品種を予測します</p>
<h2>使用方法:</h2>
<p>POST /predict に以下のJSON形式でデータを送信:</p>
<pre>
{
“sepal_length”: 5.1,
“sepal_width”: 3.5,
“petal_length”: 1.4,
“petal_width”: 0.2
}
</pre>
“””

@app.route(’/predict’, methods=[‘POST’])
def predict():
“”“予測を行うエンドポイント”””
try:
# リクエストからデータを取得
data = request.get_json()

```
    # 必要な項目があるかチェック
    required_fields = ['sepal_length', 'sepal_width', 'petal_length', 'petal_width']
    for field in required_fields:
        if field not in data:
            return jsonify({'error': f'{field} が必要です'}), 400
    
    # 特徴量の準備
    features = np.array([[
        data['sepal_length'],
        data['sepal_width'], 
        data['petal_length'],
        data['petal_width']
    ]])
    
    # 予測の実行
    prediction = model.predict(features)[0]
    probability = model.predict_proba(features)[0]
    
    # 結果の準備
    result = {
        'prediction': species_mapping[prediction],
        'prediction_id': int(prediction),
        'probabilities': {
            species_mapping[i]: float(prob) 
            for i, prob in enumerate(probability)
        }
    }
    
    return jsonify(result)
    
except Exception as e:
    return jsonify({'error': str(e)}), 500
```

@app.route(’/health’, methods=[‘GET’])
def health_check():
“”“サーバーの健康状態をチェック”””
return jsonify({‘status’: ‘healthy’, ‘message’: ‘API is running’})

if **name** == ‘**main**’:
app.run(debug=True, host=‘0.0.0.0’, port=5000)</code></pre>
</section>

```
<section id="step3">
    <h2>ステップ3: API の起動とテスト</h2>

    <div class="step-box">
        <div class="step-title">サーバーの起動</div>
        <pre><code>python app.py</code></pre>
        <p>サーバーが起動すると、<code>http://localhost:5000</code> でAPIにアクセスできます。</p>
    </div>

    <h3>API のテスト方法</h3>

    <h4>1. ブラウザでの確認</h4>
    <p><code>http://localhost:5000</code> にアクセスして、API の説明ページを確認します。</p>

    <h4>2. curl でのテスト</h4>
    <pre><code># 予測リクエストの送信
```

curl -X POST http://localhost:5000/predict   
-H “Content-Type: application/json”   
-d ‘{
“sepal_length”: 5.1,
“sepal_width”: 3.5,
“petal_length”: 1.4,
“petal_width”: 0.2
}’

# ヘルスチェック

curl http://localhost:5000/health</code></pre>

```
    <h4>3. Python でのテスト</h4>
    <pre><code># test_api.py
```

import requests
import json

# APIのURL

url = ‘http://localhost:5000/predict’

# テストデータ

test_data = {
‘sepal_length’: 5.1,
‘sepal_width’: 3.5,
‘petal_length’: 1.4,
‘petal_width’: 0.2
}

# リクエストの送信

response = requests.post(url, json=test_data)

if response.status_code == 200:
result = response.json()
print(“予測結果:”)
print(f”品種: {result[‘prediction’]}”)
print(“確率:”)
for species, prob in result[‘probabilities’].items():
print(f”  {species}: {prob:.3f}”)
else:
print(f”エラー: {response.status_code}”)
print(response.text)</code></pre>
</section>

```
<section id="step4">
    <h2>ステップ4: エラーハンドリングの改善</h2>
    
    <div class="warning">
        実際のアプリケーションでは、様々な種類のエラーが発生する可能性があります。これは<strong>レストランで注文を受ける際に、メニューにない料理を注文されたり、アレルギー情報が不明だったりする状況</strong>と似ています。
    </div>

    <pre><code># improved_app.py（一部抜粋）
```

def validate_input(data):
“”“入力データの検証”””
required_fields = [‘sepal_length’, ‘sepal_width’, ‘petal_length’, ‘petal_width’]

```
# 必要なフィールドの存在確認
for field in required_fields:
    if field not in data:
        return False, f'{field} が必要です'

# 数値型の確認
for field in required_fields:
    try:
        float(data[field])
    except (ValueError, TypeError):
        return False, f'{field} は数値である必要があります'

# 値の範囲確認（実際のアイリスデータの範囲）
ranges = {
    'sepal_length': (4.0, 8.0),
    'sepal_width': (2.0, 4.5),
    'petal_length': (1.0, 7.0),
    'petal_width': (0.1, 2.5)
}

for field, (min_val, max_val) in ranges.items():
    value = float(data[field])
    if not (min_val <= value <= max_val):
        return False, f'{field} は {min_val} から {max_val} の間である必要があります'

return True, None</code></pre>
</section>

<section id="step5">
    <h2>ステップ5: 本番環境への対応</h2>

    <h3>1. 環境変数の使用</h3>
    <pre><code># config.py
```

import os

class Config:
MODEL_PATH = os.environ.get(‘MODEL_PATH’, ‘iris_model.pkl’)
SPECIES_MAPPING_PATH = os.environ.get(‘SPECIES_MAPPING_PATH’, ‘species_mapping.pkl’)
DEBUG = os.environ.get(‘FLASK_DEBUG’, ‘False’).lower() == ‘true’
PORT = int(os.environ.get(‘PORT’, 5000))
HOST = os.environ.get(‘HOST’, ‘0.0.0.0’)</code></pre>

```
    <h3>2. Docker化</h3>
    <pre><code># Dockerfile
```

FROM python:3.9-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install -r requirements.txt

COPY . .

EXPOSE 5000

CMD [“python”, “app.py”]</code></pre>

```
    <pre><code># requirements.txt
```

Flask==2.3.2
scikit-learn==1.3.0
pandas==2.0.3
numpy==1.24.3
joblib==1.3.1
gunicorn==21.2.0</code></pre>

```
    <h3>3. Gunicorn での起動</h3>
    <pre><code># 本番環境では Gunicorn を使用
```

gunicorn –bind 0.0.0.0:5000 –workers 4 app:app</code></pre>
</section>

```
<section id="step6">
    <h2>ステップ6: API ドキュメントの作成</h2>
    
    <div class="info">
        良いAPIには、使い方を説明するドキュメントが必要です。これは<strong>レストランのメニュー</strong>のようなものです。
    </div>

    <div class="example">
        APIドキュメントエンドポイントの例を作成して、利用者が簡単に使い方を理解できるようにします。レスポンス例や エラーコードの説明も含めることで、開発者にとって使いやすいAPIになります。
    </div>
</section>

<section id="summary">
    <h2>まとめ</h2>
    
    <p>このチュートリアルでは、機械学習モデルをWeb APIとして公開する方法を学びました。重要なポイントは以下の通りです：</p>
    
    <div class="step-box">
        <ol>
            <li><strong>モデルの保存</strong>: 訓練したモデルを <code>joblib</code> で保存</li>
            <li><strong>Flask での API 作成</strong>: シンプルで軽量なWebフレームワークを使用</li>
            <li><strong>エラーハンドリング</strong>: 様々な入力に対して適切に対応</li>
            <li><strong>バリデーション</strong>: 入力データの検証で予期しないエラーを防止</li>
            <li><strong>本番対応</strong>: Docker化や環境変数の使用で実際の運用に対応</li>
            <li><strong>ドキュメント</strong>: APIの使い方を明確に説明</li>
        </ol>
    </div>
    
    <div class="highlight">
        <p>これで、あなたの機械学習モデルは<strong>24時間営業のレストラン</strong>のように、いつでもどこからでもアクセスできる形になりました！</p>
    </div>
</section>

<section id="next-steps">
    <h2>次のステップ</h2>
    
    <ul>
        <li>より複雑なモデル（ディープラーニングなど）のAPI化</li>
        <li>認証機能の追加</li>
        <li>キャッシュ機能の実装</li>
        <li>モニタリングとログ分析</li>
        <li>A/Bテスト機能の追加</li>
    </ul>
</section>

<div class="footer">
    <p>機械学習モデルAPI化チュートリアル | 作成日: 2025年8月</p>
</div>
```

</body>
</html>