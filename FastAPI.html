<!DOCTYPE html>

<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>機械学習モデルのAPI化チュートリアル（FastAPI編）</title>
    <style>
        body {
            font-family: 'Hiragino Kaku Gothic Pro', 'ヒラギノ角ゴ Pro', 'Yu Gothic Medium', '游ゴシック Medium', YuGothic, '游ゴシック体', 'Meiryo', sans-serif;
            line-height: 1.7;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #fafafa;
        }

```
    .container {
        background-color: white;
        padding: 40px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    h1 {
        color: #2c5aa0;
        text-align: center;
        border-bottom: 3px solid #2c5aa0;
        padding-bottom: 15px;
        margin-bottom: 30px;
        font-size: 2.2em;
    }
    
    h2 {
        color: #e74c3c;
        border-left: 5px solid #e74c3c;
        padding-left: 15px;
        margin-top: 35px;
        margin-bottom: 20px;
        font-size: 1.5em;
    }
    
    h3 {
        color: #27ae60;
        margin-top: 25px;
        margin-bottom: 15px;
        font-size: 1.3em;
    }
    
    h4 {
        color: #8e44ad;
        margin-top: 20px;
        margin-bottom: 10px;
        font-size: 1.1em;
    }
    
    pre {
        background-color: #2d3748;
        color: #e2e8f0;
        padding: 20px;
        border-radius: 8px;
        overflow-x: auto;
        margin: 15px 0;
        border-left: 4px solid #4299e1;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.9em;
    }
    
    code {
        background-color: #f1f5f9;
        color: #e53e3e;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        font-size: 0.9em;
    }
    
    .example-box {
        background-color: #f0f8ff;
        border: 2px solid #4299e1;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
    }
    
    .example-box h4 {
        color: #2c5aa0;
        margin-top: 0;
    }
    
    .warning-box {
        background-color: #fffbf0;
        border: 2px solid #f6ad55;
        border-radius: 8px;
        padding: 15px;
        margin: 20px 0;
    }
    
    .warning-box h4 {
        color: #c05621;
        margin-top: 0;
    }
    
    .info-box {
        background-color: #f0fff4;
        border: 2px solid #68d391;
        border-radius: 8px;
        padding: 15px;
        margin: 20px 0;
    }
    
    .info-box h4 {
        color: #22543d;
        margin-top: 0;
    }
    
    ul, ol {
        padding-left: 25px;
    }
    
    li {
        margin-bottom: 8px;
    }
    
    table {
        border-collapse: collapse;
        width: 100%;
        margin: 20px 0;
    }
    
    th, td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: left;
    }
    
    th {
        background-color: #f8f9fa;
        color: #495057;
        font-weight: bold;
    }
    
    .file-structure {
        background-color: #1a202c;
        color: #e2e8f0;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
    }
    
    .emoji {
        font-size: 1.2em;
    }
    
    @media print {
        body {
            background-color: white;
            font-size: 12pt;
        }
        
        .container {
            box-shadow: none;
            border: none;
        }
        
        pre {
            background-color: #f8f9fa !important;
            color: #333 !important;
            border: 1px solid #ddd;
            page-break-inside: avoid;
        }
        
        h1, h2, h3 {
            page-break-after: avoid;
        }
        
        .example-box, .warning-box, .info-box {
            page-break-inside: avoid;
            border-color: #ddd;
        }
    }
</style>
```

</head>
<body>
    <div class="container">
        <h1>🤖 機械学習モデルのAPI化チュートリアル（FastAPI編）</h1>

```
    <h2>📋 概要</h2>
    <p>このチュートリアルでは、機械学習モデルをFastAPIを使ってAPI化する方法を学びます。</p>

    <div class="example-box">
        <h4>🏪 例え話：レストランのオーダーシステム</h4>
        <p>これはレストランのオーダーシステムのようなものです。お客さん（クライアント）がメニュー（データ）を注文すると、厨房（機械学習モデル）が料理（予測結果）を作って提供する仕組みです。</p>
    </div>

    <h2>🌸 使用するモデル</h2>
    <p>今回は、アヤメの花の特徴から品種を分類するモデルを作成します。</p>
    <ul>
        <li><strong>入力：</strong> 花びらの長さ、幅、がくの長さ、幅</li>
        <li><strong>出力：</strong> アヤメの品種（setosa、versicolor、virginica）</li>
    </ul>

    <h2>📦 必要なパッケージのインストール</h2>
    <pre><code>pip install fastapi uvicorn scikit-learn pandas numpy joblib</code></pre>

    <h2>ステップ1: 機械学習モデルの作成と保存</h2>
    <p>まず、機械学習モデルを作成して保存しましょう。</p>

    <h3>📄 train_model.py</h3>
    <pre><code># train_model.py
```

import pandas as pd
from sklearn.datasets import load_iris
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split
from sklearn.metrics import accuracy_score
import joblib

# データの読み込み

iris = load_iris()
X, y = iris.data, iris.target

# 訓練用とテスト用にデータを分割

X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# モデルの作成と訓練

model = RandomForestClassifier(n_estimators=100, random_state=42)
model.fit(X_train, y_train)

# モデルの評価

predictions = model.predict(X_test)
accuracy = accuracy_score(y_test, predictions)
print(f”モデルの精度: {accuracy:.2f}”)

# モデルの保存

joblib.dump(model, ‘iris_model.pkl’)
print(“モデルを iris_model.pkl に保存しました”)

# 特徴量の名前とクラス名も保存

feature_names = iris.feature_names
class_names = iris.target_names.tolist()

model_info = {
‘feature_names’: feature_names,
‘class_names’: class_names
}
joblib.dump(model_info, ‘model_info.pkl’)</code></pre>

```
    <h2>ステップ2: データモデルの定義</h2>
    <p>APIで受け取るデータの形式を定義します。これは、レストランのメニューを決めるようなものです。</p>

    <h3>📄 models.py</h3>
    <pre><code># models.py
```

from pydantic import BaseModel
from typing import List

class IrisFeatures(BaseModel):
“”“アヤメの特徴量を受け取るためのデータモデル”””
sepal_length: float  # がくの長さ
sepal_width: float   # がくの幅
petal_length: float  # 花びらの長さ
petal_width: float   # 花びらの幅

```
class Config:
    schema_extra = {
        "example": {
            "sepal_length": 5.1,
            "sepal_width": 3.5,
            "petal_length": 1.4,
            "petal_width": 0.2
        }
    }
```

class PredictionResponse(BaseModel):
“”“予測結果を返すためのデータモデル”””
predicted_class: str
confidence: float
probabilities: dict</code></pre>

```
    <h2>ステップ3: FastAPIアプリケーションの作成</h2>
    <p>メインのAPIアプリケーションを作成します。</p>

    <h3>📄 main.py</h3>
    <pre><code># main.py
```

from fastapi import FastAPI, HTTPException
from fastapi.responses import HTMLResponse
import joblib
import numpy as np
from models import IrisFeatures, PredictionResponse
import uvicorn

# FastAPIアプリケーションの作成

app = FastAPI(
title=“アヤメ分類API”,
description=“アヤメの花の特徴から品種を予測するAPI”,
version=“1.0.0”
)

# モデルとメタ情報の読み込み

try:
model = joblib.load(‘iris_model.pkl’)
model_info = joblib.load(‘model_info.pkl’)
print(“モデルの読み込みが完了しました”)
except FileNotFoundError:
print(“エラー: モデルファイルが見つかりません。先にtrain_model.pyを実行してください。”)
model = None
model_info = None

@app.get(”/”, response_class=HTMLResponse)
async def root():
“”“ホームページ - APIの使い方を表示”””
html_content = “””
<!DOCTYPE html>
<html>
<head>
<title>アヤメ分類API</title>
<style>
body { font-family: Arial, sans-serif; margin: 40px; }
.container { max-width: 800px; }
.example { background-color: #f5f5f5; padding: 10px; border-radius: 5px; }
</style>
</head>
<body>
<div class=“container”>
<h1>🌸 アヤメ分類API</h1>
<p>このAPIは、アヤメの花の特徴から品種を予測します。</p>

```
        &lt;h2&gt;使用方法&lt;/h2&gt;
        &lt;p&gt;&lt;code&gt;/predict&lt;/code&gt; エンドポイントにPOSTリクエストを送信してください。&lt;/p&gt;
        
        &lt;h2&gt;例&lt;/h2&gt;
        &lt;div class="example"&gt;
            &lt;pre&gt;
```

{
“sepal_length”: 5.1,
“sepal_width”: 3.5,
“petal_length”: 1.4,
“petal_width”: 0.2
}
</pre>
</div>

```
        &lt;h2&gt;API仕様書&lt;/h2&gt;
        &lt;p&gt;&lt;a href="/docs"&gt;Swagger UI&lt;/a&gt; | &lt;a href="/redoc"&gt;ReDoc&lt;/a&gt;&lt;/p&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
"""
return html_content
```

@app.post(”/predict”, response_model=PredictionResponse)
async def predict_iris(features: IrisFeatures):
“”“アヤメの品種を予測する”””

```
if model is None:
    raise HTTPException(
        status_code=500, 
        detail="モデルが読み込まれていません。train_model.pyを先に実行してください。"
    )

try:
    # 入力データを配列に変換
    input_data = np.array([[
        features.sepal_length,
        features.sepal_width,
        features.petal_length,
        features.petal_width
    ]])
    
    # 予測実行
    prediction = model.predict(input_data)[0]
    probabilities = model.predict_proba(input_data)[0]
    
    # 結果を整理
    predicted_class = model_info['class_names'][prediction]
    confidence = float(max(probabilities))
    
    prob_dict = {
        model_info['class_names'][i]: float(prob) 
        for i, prob in enumerate(probabilities)
    }
    
    return PredictionResponse(
        predicted_class=predicted_class,
        confidence=confidence,
        probabilities=prob_dict
    )
    
except Exception as e:
    raise HTTPException(status_code=400, detail=f"予測エラー: {str(e)}")
```

@app.get(”/health”)
async def health_check():
“”“ヘルスチェック”””
return {
“status”: “healthy”,
“model_loaded”: model is not None,
“message”: “APIは正常に動作しています”
}

@app.get(”/model-info”)
async def get_model_info():
“”“モデルの情報を取得”””
if model_info is None:
raise HTTPException(status_code=500, detail=“モデル情報が読み込まれていません”)

```
return {
    "feature_names": model_info['feature_names'],
    "class_names": model_info['class_names'],
    "model_type": "RandomForestClassifier"
}
```

if **name** == “**main**”:
uvicorn.run(app, host=“0.0.0.0”, port=8000)</code></pre>

```
    <h2>ステップ4: APIのテスト用スクリプト</h2>
    <p>APIが正しく動作するかテストするスクリプトを作成します。</p>

    <h3>📄 test_api.py</h3>
    <pre><code># test_api.py
```

import requests
import json

# APIのベースURL

BASE_URL = “http://localhost:8000”

def test_prediction():
“”“予測APIをテスト”””
# テストデータ
test_data = {
“sepal_length”: 5.1,
“sepal_width”: 3.5,
“petal_length”: 1.4,
“petal_width”: 0.2
}

```
# APIリクエストを送信
response = requests.post(f"{BASE_URL}/predict", json=test_data)

if response.status_code == 200:
    result = response.json()
    print("✅ 予測成功!")
    print(f"予測品種: {result['predicted_class']}")
    print(f"信頼度: {result['confidence']:.2f}")
    print("各品種の確率:")
    for class_name, prob in result['probabilities'].items():
        print(f"  {class_name}: {prob:.3f}")
else:
    print(f"❌ エラー: {response.status_code}")
    print(response.text)
```

def test_health():
“”“ヘルスチェックをテスト”””
response = requests.get(f”{BASE_URL}/health”)
if response.status_code == 200:
print(“✅ ヘルスチェック成功!”)
print(json.dumps(response.json(), indent=2, ensure_ascii=False))
else:
print(f”❌ ヘルスチェックエラー: {response.status_code}”)

if **name** == “**main**”:
print(”=== APIテスト開始 ===”)

```
print("\n1. ヘルスチェック")
test_health()

print("\n2. 予測テスト")
test_prediction()

print("\n=== テスト完了 ===")</code></pre>

    <h2>🚀 実行手順</h2>

    <h3>1. モデルの作成</h3>
    <pre><code>python train_model.py</code></pre>

    <h3>2. APIサーバーの起動</h3>
    <pre><code>python main.py</code></pre>
    <p>または</p>
    <pre><code>uvicorn main:app --reload --host 0.0.0.0 --port 8000</code></pre>

    <h3>3. ブラウザでAPIドキュメントを確認</h3>
    <ul>
        <li>Swagger UI: <code>http://localhost:8000/docs</code></li>
        <li>ReDoc: <code>http://localhost:8000/redoc</code></li>
        <li>ホームページ: <code>http://localhost:8000</code></li>
    </ul>

    <h3>4. APIのテスト</h3>
    <p>別のターミナルで：</p>
    <pre><code>python test_api.py</code></pre>

    <h2>🔧 curlでのテスト例</h2>

    <h3>予測リクエスト</h3>
    <pre><code>curl -X POST "http://localhost:8000/predict" \
 -H "Content-Type: application/json" \
 -d '{
   "sepal_length": 5.1,
   "sepal_width": 3.5,
   "petal_length": 1.4,
   "petal_width": 0.2
 }'</code></pre>

    <h3>ヘルスチェック</h3>
    <pre><code>curl http://localhost:8000/health</code></pre>

    <h3>モデル情報取得</h3>
    <pre><code>curl http://localhost:8000/model-info</code></pre>

    <h2>📁 プロジェクト構成</h2>
    <div class="file-structure">
```

iris-api/
├── main.py           # メインのAPIアプリケーション
├── models.py         # データモデルの定義
├── train_model.py    # モデルの訓練と保存
├── test_api.py       # APIテスト用スクリプト
├── iris_model.pkl    # 保存された機械学習モデル
└── model_info.pkl    # モデルのメタ情報
</div>

```
    <h2>🌍 本番環境への展開のヒント</h2>

    <h3>1. Docker化</h3>
    <pre><code>FROM python:3.9-slim
```

WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD [“uvicorn”, “main:app”, “–host”, “0.0.0.0”, “–port”, “8000”]</code></pre>

```
    <h3>2. 環境変数の使用</h3>
    <pre><code>import os
```

PORT = int(os.getenv(“PORT”, 8000))</code></pre>

```
    <h3>3. ログの追加</h3>
    <pre><code>import logging
```

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(**name**)</code></pre>

```
    <h3>4. セキュリティ強化</h3>
    <pre><code>from fastapi.middleware.cors import CORSMiddleware
```

app.add_middleware(CORSMiddleware, …)</code></pre>

```
    <h2>📝 まとめ</h2>
    <p>このチュートリアルでは、機械学習モデルをFastAPIでAPI化する基本的な方法を学びました。</p>

    <div class="info-box">
        <h4>🎯 重要なポイント</h4>
        <ul>
            <li>モデルの保存と読み込み（joblib使用）</li>
            <li>Pydanticを使ったデータ検証</li>
            <li>適切なエラーハンドリング</li>
            <li>API仕様書の自動生成</li>
            <li>テストの重要性</li>
        </ul>
    </div>

    <div class="example-box">
        <h4>🏪 例え話で振り返ると</h4>
        <p>レストラン（API）を開店し、メニュー（データモデル）を決め、厨房（機械学習モデル）を準備し、注文システム（エンドポイント）を構築し、最後にお客さん（クライアント）が満足するかテストしました。</p>
    </div>

    <div class="warning-box">
        <h4>🎉 おめでとうございます！</h4>
        <p>これで、あなたの機械学習モデルは世界中どこからでもアクセスできるAPIになりました！</p>
    </div>
</div>
```

</body>
</html>